project: craft-tests

environment:
  CHARM_CHANNEL: latest/stable
  CHARMCRAFT_CHANNEL: latest/stable
  JUJU_CHANNEL: latest/stable
  JUJU_BUNDLE_CHANNEL: latest/stable
  JUJU_CRASHDUMP_CHANNEL: latest/stable
  LXD_CHANNEL: latest/stable
  MICROK8S_CHANNEL: latest/stable

  PROVIDER: undefined
  MICROK8S_ADDONS: hostpath-storage

  JUJU_BOOTSTRAP_OPTIONS: --model-default test-mode=true --model-default automatically-retry-hooks=false --model-default #logging-config="<root>=DEBUG"
  JUJU_EXTRA_BOOTSTRAP_OPTIONS: ""
  JUJU_BOOTSTRAP_CONSTRAINTS: ""

  # important to ensure adhoc and linode/qemu behave the same
  SUDO_USER: ""
  SUDO_UID: ""
  
  LANG: "C.UTF-8"
  LANGUAGE: "en"

  PROJECT_PATH: /home/spread/proj
  CRAFT_TEST_PATH: /home/spread/proj/tests/spread/lib

backends:
  external:
    type: adhoc
    environment:
      SPREAD_EXTERNAL_ADDRESS: '$(HOST: echo "${SPREAD_EXTERNAL_ADDRESS:-localhost:8022}")'
      TRUST_TEST_KEYS: "false"
    allocate: |
      sleep 0.$RANDOM
      sleep 0.$RANDOM
      sleep 0.$RANDOM

      export counter_file="$HOME/.spread/multipass-count"
      instance_num=$(flock -x $counter_file bash -c '
        [ -s $counter_file ] || echo 0 > $counter_file
        num=$(< $counter_file)
        echo $num
        echo $(( $num + 1 )) > $counter_file')

      multipass_image=$(echo "${SPREAD_SYSTEM}" | sed -e s/ubuntu-// -e s/-64//)

      system=$(echo "${SPREAD_SYSTEM}" | tr . -)
      instance_name="spread-${SPREAD_BACKEND}-${instance_num}-${system}"

      multipass launch -vv --cpus 2 --disk 20G --memory 4G --name "${instance_name}" \
        --cloud-init tests/spread/lib/cloud-config.yaml "${multipass_image}"

      # Get the IP from the instance
      ip=$(multipass info --format csv "$instance_name" | tail -1 | cut -d\, -f3)
      ADDRESS "$ip"

    discard: |
      instance_name=$(multipass list --format csv | grep $SPREAD_SYSTEM_ADDRESS | cut -f1 -d\,)
      multipass delete --purge "${instance_name}"

    systems:
      - ubuntu-22.04:
          username: spread
          password: spread
          workers: 1

      #- ubuntu-20.04:
      #    username: spread
      #    password: spread
      #    workers: 2

suites:
  tests/spread/:
    summary: Spread tests


exclude:
  - .git
  - .tox

path: /home/spread/proj

prepare: |
  snap refresh --hold

  if systemctl is-enabled unattended-upgrades.service; then
    systemctl stop unattended-upgrades.service
    systemctl mask unattended-upgrades.service
  fi

restore: |
  apt autoremove -y --purge
  rm -Rf "$PROJECT_PATH"
  mkdir -p "$PROJECT_PATH"


kill-timeout: 15m

workers: 1

